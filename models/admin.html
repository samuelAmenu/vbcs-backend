<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VBCS Admin (Recovery Mode)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #1a1f36; --accent: #009639; --bg: #f4f6f8; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 260px; background: #111; color: white; display: flex; flex-direction: column; }
        .brand { padding: 25px; font-size: 20px; font-weight: bold; border-bottom: 1px solid #333; }
        .menu { flex: 1; padding-top: 20px; }
        .nav-link { padding: 15px 25px; color: #aaa; cursor: pointer; display: flex; gap: 10px; align-items: center; text-decoration: none; }
        .nav-link:hover, .nav-link.active { background: #333; color: white; border-left: 4px solid var(--accent); }
        .main { flex: 1; display: flex; flex-direction: column; position: relative; }
        .content-area { padding: 30px; overflow-y: auto; flex: 1; padding-bottom: 200px; }
        .page { display: none; }
        .page.active { display: block; }
        
        .card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .card h3 { margin: 0 0 10px 0; font-size: 12px; color: #666; text-transform: uppercase; }
        .card .val { font-size: 28px; font-weight: bold; color: #333; }
        
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; font-size: 12px; text-transform: uppercase; color: #555; }
        
        .input-group { display: flex; gap: 10px; margin-bottom: 15px; }
        input, select, textarea { padding: 10px; border: 1px solid #ddd; border-radius: 5px; flex: 1; }
        .btn { background: var(--accent); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #111; z-index: 999; display: flex; justify-content: center; align-items: center; }
        .login-box { background: white; padding: 40px; border-radius: 10px; width: 300px; text-align: center; }
        
        /* DEBUG CONSOLE */
        #debug-console {
            position: fixed; bottom: 0; left: 260px; right: 0; height: 150px;
            background: #222; color: #0f0; font-family: monospace; font-size: 12px;
            padding: 10px; overflow-y: auto; border-top: 2px solid #444; z-index: 1000;
        }
        .log-entry { margin-bottom: 4px; border-bottom: 1px solid #333; }
        .log-err { color: #ff5555; font-weight: bold; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h2>VBCS Admin</h2>
            <p>Recovery Mode</p>
            <input type="text" id="user" placeholder="Username">
            <input type="password" id="pass" placeholder="Password" style="margin-top:10px;">
            <button class="btn" onclick="handleLogin()" style="width:100%; margin-top:15px;">Secure Login</button>
            <p id="login-msg" style="color:red; font-size:13px; margin-top:10px;"></p>
        </div>
    </div>

    <div class="sidebar">
        <div class="brand">VBCS COMMAND</div>
        <div class="menu">
            <a class="nav-link active" onclick="nav('dashboard')"><i class="fas fa-chart-line"></i> Dashboard</a>
            <a class="nav-link" onclick="nav('b2c')"><i class="fas fa-users"></i> B2C Subscribers</a>
            <a class="nav-link" onclick="nav('b2b')"><i class="fas fa-building"></i> B2B Enterprises</a>
            <a class="nav-link" onclick="nav('directory')"><i class="fas fa-book"></i> Directory</a>
            <a class="nav-link" onclick="nav('fraud')"><i class="fas fa-shield-alt"></i> Fraud Reports</a>
            <a class="nav-link" onclick="nav('settings')"><i class="fas fa-cog"></i> Settings</a>
        </div>
    </div>

    <div class="main">
        <div class="content-area">
            <div id="dashboard-page" class="page active">
                <h1>System Overview</h1>
                <div class="card-grid">
                    <div class="card"><h3>Revenue</h3><div class="val" id="d-rev">$0</div></div>
                    <div class="card"><h3>Subscribers</h3><div class="val" id="d-users">0</div></div>
                    <div class="card"><h3>Enterprises</h3><div class="val" id="d-ent">0</div></div>
                </div>
            </div>

            <div id="b2c-page" class="page">
                <h1>Subscribers (B2C)</h1>
                <button class="btn" onclick="loadUsers('b2b')" style="margin-bottom:10px;">Refresh</button>
                <table id="b2c-table"><thead><tr><th>Name</th><th>Phone</th><th>Status</th><th>Joined</th></tr></thead><tbody></tbody></table>
            </div>

            <div id="b2b-page" class="page">
                <h1>Enterprises (B2B)</h1>
                <button class="btn" onclick="loadUsers('b2b')" style="margin-bottom:10px;">Refresh</button>
                <table id="b2b-table"><thead><tr><th>Company</th><th>Phone</th><th>Role</th><th>Joined</th></tr></thead><tbody></tbody></table>
            </div>

            <div id="directory-page" class="page">
                <h1>Directory</h1>
                <div class="card">
                    <h3>Bulk Upload CSV</h3>
                    <input type="file" id="csv-file" accept="*/*">
                    <button class="btn" onclick="uploadCsv(this)" style="margin-top:10px;">Upload Database</button>
                </div>
                <table id="dir-table"><thead><tr><th>Name</th><th>Phone</th><th>Category</th></tr></thead><tbody></tbody></table>
            </div>
            
             <div id="fraud-page" class="page">
                <h1>Fraud Intelligence</h1>
                <table id="fraud-table"><thead><tr><th>Target Number</th><th>Reason</th><th>Reporter</th><th>Action</th></tr></thead><tbody></tbody></table>
            </div>

            <div id="settings-page" class="page">
                <h1>Administrator Settings</h1>
                <div class="card">
                    <h3>Manage Categories</h3>
                    <div class="input-group">
                        <input id="new-cat" placeholder="New Category Name">
                        <button class="btn" onclick="addCategory()">Add Category</button>
                    </div>
                    <div id="cat-list"></div>
                </div>
                 <div class="card">
                    <h3>Security</h3>
                    <div class="input-group">
                        <input type="password" id="new-pass" placeholder="New Admin Password">
                        <button class="btn btn-danger" onclick="changePass()">Update Password</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="debug-console">
            <div><strong>SYSTEM LOG (Errors will appear here)</strong></div>
        </div>
    </div>

    <script>
        // --- 1. CRASH DETECTOR (Must be at the top) ---
        window.addEventListener('error', function(event) {
            const msg = `CRITICAL ERROR: ${event.message} at line ${event.lineno}`;
            alert(msg);
            const box = document.getElementById('debug-console');
            if(box) box.innerHTML += `<div class="log-entry log-err">${msg}</div>`;
        });

        // --- 2. CONFIG ---
        const API = 'https://vbcs-backend-1.onrender.com/api/v1/owner';
        let currentUser = '';

        function log(msg, type='info') {
            const box = document.getElementById('debug-console');
            if(box) {
                const div = document.createElement('div');
                div.className = 'log-entry ' + (type==='error'?'log-err':'');
                div.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
                box.appendChild(div);
                box.scrollTop = box.scrollHeight;
            }
            console.log(msg);
        }

        log("System initialized. Waiting for user input...");

        // --- 3. AUTH ---
        async function handleLogin() {
            const u = document.getElementById('user').value;
            const p = document.getElementById('pass').value;
            const btn = document.querySelector('#login-overlay button');
            
            log(`Attempting login for: ${u}`);
            btn.innerText = "Checking...";
            
            try {
                const res = await fetch(`${API}/login`, { 
                    method:'POST', 
                    headers:{'Content-Type':'application/json'}, 
                    body:JSON.stringify({username:u, password:p}) 
                });
                
                const d = await res.json();
                
                if(d.success) {
                    log("Login Success!");
                    document.getElementById('login-overlay').style.display = 'none';
                    currentUser = u;
                    loadStats(); 
                } else {
                    log(`Login Failed: ${d.message}`, 'error');
                    document.getElementById('login-msg').innerText = d.message;
                    btn.innerText = "Secure Login";
                }
            } catch(e) { 
                log(`Network Error: ${e.message}`, 'error');
                btn.innerText = "Secure Login";
                alert("Cannot connect to server. Check your internet.");
            }
        }

        function nav(page) {
            log(`Navigating to ${page}`);
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            document.getElementById(`${page}-page`).classList.add('active');
            
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
            
            if(page === 'b2c') loadUsers('b2c');
            if(page === 'b2b') loadUsers('b2b');
            if(page === 'directory') loadDirectory();
            if(page === 'fraud') loadFraud();
        }

        // --- 4. LOADERS ---
        async function loadUsers(type) {
            log(`Loading ${type} users...`);
            const tbody = document.querySelector(`#${type}-table tbody`);
            tbody.innerHTML = '<tr><td colspan="4">Loading...</td></tr>';
            
            try {
                const res = await fetch(`${API}/subscribers/${type}`);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const d = await res.json();
                
                log(`Found ${d.length} users.`);
                
                if(!Array.isArray(d) || d.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4">No data found.</td></tr>';
                    return;
                }
                
                tbody.innerHTML = d.map(u => `
                    <tr>
                        <td>${u.fullName || u.companyName || 'Unknown'}</td>
                        <td>${u.phoneNumber}</td>
                        <td>${u.role}</td>
                        <td>${new Date(u.createdAt).toLocaleDateString()}</td>
                    </tr>`).join('');
            } catch(e) { 
                log(`Error: ${e.message}`, 'error');
                tbody.innerHTML = `<tr><td colspan="4" style="color:red">Error loading data</td></tr>`; 
            }
        }

        async function loadDirectory() {
            log("Loading directory...");
            const tbody = document.querySelector('#dir-table tbody');
            try {
                const res = await fetch(`${API}/directory`);
                const d = await res.json();
                log(`Found ${d.length} directory entries`);
                tbody.innerHTML = d.map(i => `<tr><td>${i.companyName}</td><td>${i.phoneNumber}</td><td>${i.category}</td></tr>`).join('');
            } catch(e) { log(`Directory Error: ${e.message}`, 'error'); }
        }
        
         async function loadFraud() {
            const tbody = document.querySelector('#fraud-table tbody');
            try {
                const res = await fetch(`${API}/fraud-reports`);
                const d = await res.json();
                tbody.innerHTML = d.map(i => `
                    <tr>
                        <td style="color:#d32f2f; font-weight:bold;">${i.reportedNumber}</td>
                        <td>${i.reason}</td>
                        <td>${i.comments || '-'}</td>
                        <td><button class="btn btn-danger" style="padding:5px 10px; font-size:12px;" onclick="suspend('${i.reportedNumber}')">Suspend</button></td>
                    </tr>`).join('');
            } catch(e) {}
        }

        async function loadStats() {
             try {
                const res = await fetch(`${API}/stats`);
                const d = await res.json();
                document.getElementById('d-rev').innerText = `$${(d.totalMonthlyRevenue||0).toLocaleString()}`;
                document.getElementById('d-users').innerText = d.totalB2CSubscribers || 0;
                document.getElementById('d-ent').innerText = d.totalEnterprises || 0;
            } catch(e) {}
        }
        
        async function suspend(num) {
            if(!confirm(`Permanently suspend ${num}?`)) return;
            await fetch(`${API}/suspend-number`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ number: num })
            });
            alert("Number Suspended");
            loadFraud();
        }
        
         async function addCategory() {
            const name = document.getElementById('new-cat').value;
            if(!name) return;
            await fetch(`${API}/categories`, { 
                method:'POST', 
                headers:{'Content-Type':'application/json'}, 
                body:JSON.stringify({name}) 
            });
            document.getElementById('new-cat').value = '';
            alert("Category Added");
        }
        
        async function changePass() {
            const newPass = document.getElementById('new-pass').value;
            if(!newPass) return alert("Enter password");
            const res = await fetch(`${API}/change-password`, { 
                method:'POST', 
                headers:{'Content-Type':'application/json'}, 
                body:JSON.stringify({ username: currentUser, newPassword: newPass }) 
            });
            const d = await res.json();
            alert(d.message);
        }

        // --- 5. UPLOAD FUNCTION ---
        async function uploadCsv(btn) {
            const input = document.getElementById('csv-file');
            const file = input.files[0];
            
            if(!file) {
                log("No file selected", 'error');
                return alert("Select a file first");
            }
            
            log(`Uploading: ${file.name}`);
            const fd = new FormData();
            fd.append('file', file);
            
            const origText = btn.innerText;
            btn.innerText = "Uploading...";
            btn.disabled = true;
            
            try {
                const res = await fetch(`${API}/directory-upload`, { method:'POST', body:fd });
                const d = await res.json();
                
                log(`Server says: ${d.message}`);
                
                if(res.ok) {
                    alert(d.message);
                    input.value = ''; 
                    loadDirectory();
                } else {
                    alert("Error: " + d.message);
                }
            } catch(e) { 
                log(`Upload Crash: ${e.message}`, 'error');
                alert("Connection failed."); 
            }
            
            btn.innerText = origText;
            btn.disabled = false;
        }
    </script>
</body>
</html>