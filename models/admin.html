<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VBCS Admin (Diagnostic Mode)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #1a1f36; --accent: #009639; --bg: #f4f6f8; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* Sidebar */
        .sidebar { width: 260px; background: #111; color: white; display: flex; flex-direction: column; }
        .brand { padding: 25px; font-size: 20px; font-weight: bold; border-bottom: 1px solid #333; }
        .menu { flex: 1; padding-top: 20px; }
        .nav-link { padding: 15px 25px; color: #aaa; cursor: pointer; display: flex; gap: 10px; align-items: center; text-decoration: none; }
        .nav-link:hover, .nav-link.active { background: #333; color: white; border-left: 4px solid var(--accent); }
        
        /* Main Content */
        .main { flex: 1; display: flex; flex-direction: column; position: relative; }
        .content-area { padding: 30px; overflow-y: auto; flex: 1; padding-bottom: 200px; } /* Space for logger */
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.3s; }
        
        @keyframes fadeIn { from { opacity:0; transform:translateY(5px); } to { opacity:1; transform:translateY(0); } }

        /* Components */
        .card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .card h3 { margin: 0 0 10px 0; font-size: 12px; color: #666; text-transform: uppercase; }
        .card .val { font-size: 28px; font-weight: bold; color: #333; }
        
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; font-size: 12px; text-transform: uppercase; color: #555; }
        
        .input-group { display: flex; gap: 10px; margin-bottom: 15px; }
        input, select, textarea { padding: 10px; border: 1px solid #ddd; border-radius: 5px; flex: 1; font-family: inherit; }
        .btn { background: var(--accent); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn:hover { opacity: 0.9; }
        .btn-danger { background: #dc3545; }
        
        /* Login */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #111; z-index: 999; display: flex; justify-content: center; align-items: center; }
        .login-box { background: white; padding: 40px; border-radius: 10px; width: 300px; text-align: center; }
        
        /* Categories Tag */
        .cat-tag { background:#eee; padding:5px 10px; border-radius:15px; font-size:12px; display:inline-flex; align-items:center; margin:0 5px 5px 0; }
        .cat-tag i { margin-left:8px; color:#dc3545; cursor:pointer; }

        /* --- DIAGNOSTIC LOGGER (NEW) --- */
        #debug-console {
            position: fixed; bottom: 0; left: 260px; right: 0; height: 150px;
            background: #222; color: #0f0; font-family: monospace; font-size: 12px;
            padding: 10px; overflow-y: auto; border-top: 2px solid #444; z-index: 1000;
        }
        .log-entry { margin-bottom: 4px; border-bottom: 1px solid #333; padding-bottom: 2px; }
        .log-err { color: #ff5555; }
        .log-warn { color: #ffaa00; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h2>VBCS Admin</h2>
            <p style="color:#666; margin-bottom:20px;">Owner Portal</p>
            <input type="text" id="user" placeholder="Username">
            <input type="password" id="pass" placeholder="Password" style="margin-top:10px;">
            <button class="btn" onclick="handleLogin()" style="width:100%; margin-top:15px;">Secure Login</button>
            <p id="login-msg" style="color:red; font-size:13px; margin-top:10px;"></p>
        </div>
    </div>

    <div class="sidebar">
        <div class="brand">VBCS COMMAND</div>
        <div class="menu">
            <a class="nav-link active" onclick="nav('dashboard')"><i class="fas fa-chart-line"></i> Dashboard</a>
            <a class="nav-link" onclick="nav('b2c')"><i class="fas fa-users"></i> B2C Subscribers</a>
            <a class="nav-link" onclick="nav('b2b')"><i class="fas fa-building"></i> B2B Enterprises</a>
            <a class="nav-link" onclick="nav('directory')"><i class="fas fa-book"></i> Directory</a>
            <a class="nav-link" onclick="nav('fraud')"><i class="fas fa-shield-alt"></i> Fraud Reports</a>
            <a class="nav-link" onclick="nav('settings')"><i class="fas fa-cog"></i> Settings & Admin</a>
            <div style="flex:1"></div>
            <a class="nav-link" onclick="location.reload()" style="color:#ef5350;"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </div>
    </div>

    <div class="main">
        <div class="content-area">

            <div id="dashboard-page" class="page active">
                <h1>System Overview</h1>
                <div class="card-grid">
                    <div class="card"><h3>Total Revenue</h3><div class="val" id="d-rev">$0</div></div>
                    <div class="card"><h3>Subscribers</h3><div class="val" id="d-users">0</div></div>
                    <div class="card"><h3>Enterprises</h3><div class="val" id="d-ent">0</div></div>
                    <div class="card"><h3>Reports</h3><div class="val" id="d-rep">0</div></div>
                </div>
                <div class="card">
                    <h3>Broadcast Notification</h3>
                    <input id="notif-title" placeholder="Title" style="width:100%; box-sizing:border-box; margin-bottom:10px;">
                    <textarea id="notif-body" placeholder="Message..." style="width:100%; box-sizing:border-box;" rows="3"></textarea>
                    <button class="btn" onclick="sendBroadcast()" style="margin-top:10px;">Send Broadcast</button>
                </div>
            </div>

            <div id="b2c-page" class="page">
                <h1>Subscribers (B2C)</h1>
                <button class="btn" onclick="loadUsers('b2c')" style="margin-bottom:10px;">Refresh List</button>
                <table id="b2c-table"><thead><tr><th>Name</th><th>Phone</th><th>Status</th><th>Joined</th></tr></thead><tbody></tbody></table>
            </div>

            <div id="b2b-page" class="page">
                <h1>Enterprises (B2B)</h1>
                <button class="btn" onclick="loadUsers('b2b')" style="margin-bottom:10px;">Refresh List</button>
                <table id="b2b-table"><thead><tr><th>Company</th><th>Phone</th><th>Role</th><th>Joined</th></tr></thead><tbody></tbody></table>
            </div>

            <div id="directory-page" class="page">
                <h1>Directory Manager</h1>
                <div class="card">
                    <h3>Add Single Entry</h3>
                    <div class="input-group">
                        <input id="dir-name" placeholder="Company Name">
                        <input id="dir-phone" placeholder="Phone">
                        <select id="dir-cat"><option>Loading...</option></select>
                        <button class="btn" onclick="addDir()">Add</button>
                    </div>
                </div>
                <div class="card">
                    <h3>Bulk Upload CSV</h3>
                    <p style="font-size:12px; color:#666; margin-top:0;">1. Select File (CSV) -> 2. Click Upload</p>
                    <div class="input-group">
                        <input type="file" id="csv-file" accept="*/*">
                        <button class="btn" onclick="uploadCsv(this)">Upload Database</button>
                    </div>
                </div>
                <table id="dir-table"><thead><tr><th>Name</th><th>Phone</th><th>Category</th></tr></thead><tbody></tbody></table>
            </div>

            <div id="fraud-page" class="page">
                <h1>Fraud Intelligence</h1>
                <table id="fraud-table"><thead><tr><th>Target Number</th><th>Reason</th><th>Reporter</th><th>Action</th></tr></thead><tbody></tbody></table>
            </div>

            <div id="settings-page" class="page">
                <h1>Administrator Settings</h1>
                <div class="card">
                    <h3>Manage Categories</h3>
                    <div class="input-group">
                        <input id="new-cat" placeholder="New Category Name">
                        <button class="btn" onclick="addCategory()">Add Category</button>
                    </div>
                    <div id="cat-list"></div>
                </div>
                <div class="card">
                    <h3>Security</h3>
                    <div class="input-group">
                        <input type="password" id="new-pass" placeholder="New Admin Password">
                        <button class="btn btn-danger" onclick="changePass()">Update Password</button>
                    </div>
                </div>
            </div>

        </div>

        <div id="debug-console">
            <div><strong>SYSTEM LOG (Check here for errors)</strong></div>
        </div>
    </div>

    <script>
        const API = 'https://vbcs-backend-1.onrender.com/api/v1/owner';
        let currentUser = '';

        // --- LOGGER FUNCTION ---
        function log(msg, type = 'info') {
            const box = document.getElementById('debug-console');
            const div = document.createElement('div');
            div.className = 'log-entry ' + (type === 'error' ? 'log-err' : '');
            div.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
            console.log(msg); // Also log to normal console
        }

        // --- AUTH ---
        async function handleLogin() {
            const u = document.getElementById('user').value;
            const p = document.getElementById('pass').value;
            const btn = document.querySelector('#login-overlay button');
            
            log(`Attempting login for user: ${u}...`);
            btn.innerText = "Checking...";
            
            try {
                const res = await fetch(`${API}/login`, { 
                    method:'POST', 
                    headers:{'Content-Type':'application/json'}, 
                    body:JSON.stringify({username:u, password:p}) 
                });
                
                log(`Login Server Response: ${res.status}`);
                const d = await res.json();
                
                if(d.success) {
                    log("Login Success!");
                    document.getElementById('login-overlay').style.display = 'none';
                    currentUser = u;
                    loadStats(); 
                    loadCategories(); 
                } else {
                    log(`Login Failed: ${d.message}`, 'error');
                    document.getElementById('login-msg').innerText = d.message;
                    btn.innerText = "Secure Login";
                }
            } catch(e) { 
                log(`Network Error during login: ${e.message}`, 'error');
                document.getElementById('login-msg').innerText = "Network Error. Check System Log.";
                btn.innerText = "Secure Login";
            }
        }

        // --- NAV ---
        function nav(page) {
            log(`Navigating to: ${page}`);
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            document.getElementById(`${page}-page`).classList.add('active');
            
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
            
            if(page === 'b2c') loadUsers('b2c');
            if(page === 'b2b') loadUsers('b2b');
            if(page === 'directory') loadDirectory();
            if(page === 'fraud') loadFraud();
        }

        // --- LOADERS ---
        async function loadUsers(type) {
            log(`Fetching ${type} users...`);
            const tbody = document.querySelector(`#${type}-table tbody`);
            tbody.innerHTML = '<tr><td colspan="4">Loading...</td></tr>';
            
            try {
                const res = await fetch(`${API}/subscribers/${type}`);
                log(`User Fetch Status: ${res.status}`);
                
                if (!res.ok) throw new Error(`HTTP Error ${res.status}`);
                
                const d = await res.json();
                log(`Received ${d.length} users.`);
                
                if(d.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4">No users found in database.</td></tr>';
                    return;
                }
                
                tbody.innerHTML = d.map(u => `
                    <tr>
                        <td>${u.fullName || u.companyName || 'Unknown'}</td>
                        <td>${u.phoneNumber}</td>
                        <td>${u.role}</td>
                        <td>${new Date(u.createdAt).toLocaleDateString()}</td>
                    </tr>`).join('');
            } catch(e) { 
                log(`Error loading users: ${e.message}`, 'error');
                tbody.innerHTML = `<tr><td colspan="4" style="color:red">Error: ${e.message}</td></tr>`; 
            }
        }

        async function loadDirectory() {
            log("Loading directory...");
            try {
                const res = await fetch(`${API}/directory`);
                const d = await res.json();
                log(`Directory loaded: ${d.length} entries`);
                const tbody = document.querySelector('#dir-table tbody');
                tbody.innerHTML = d.map(i => `<tr><td>${i.companyName}</td><td>${i.phoneNumber}</td><td>${i.category}</td></tr>`).join('');
            } catch(e) { log(`Directory Load Error: ${e.message}`, 'error'); }
        }

        // --- UPLOAD FUNCTION (DIAGNOSTIC) ---
        async function uploadCsv(btn) {
            const input = document.getElementById('csv-file');
            const file = input.files[0];
            
            if(!file) {
                log("Error: No file selected.", 'error');
                return alert("Select a file first");
            }
            
            log(`Starting upload for file: ${file.name} (${file.size} bytes)`);
            
            const fd = new FormData();
            fd.append('file', file);
            
            const origText = btn.innerText;
            btn.innerText = "Uploading...";
            btn.disabled = true;
            
            try {
                log(`Sending request to: ${API}/directory-upload`);
                const res = await fetch(`${API}/directory-upload`, { method:'POST', body:fd });
                log(`Upload Response Status: ${res.status}`);
                
                const d = await res.json();
                log(`Server Message: ${d.message}`);
                
                if(res.ok) {
                    alert("Success: " + d.message);
                    input.value = ''; 
                    loadDirectory();
                } else {
                    alert("Error: " + d.message);
                    log(`Upload Logic Error: ${d.message}`, 'error');
                }
            } catch(e) { 
                log(`CRITICAL UPLOAD FAILURE: ${e.message}`, 'error');
                alert("Upload Failed. See System Log at bottom."); 
            }
            
            btn.innerText = origText;
            btn.disabled = false;
        }

        // --- SETTINGS & PRIVILEGES ---
        async function loadCategories() {
            try {
                const res = await fetch(`${API}/categories`);
                const cats = await res.json();
                const sel = document.getElementById('dir-cat');
                if(sel) sel.innerHTML = cats.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
                
                const list = document.getElementById('cat-list');
                if(list) list.innerHTML = cats.map(c => `<span class="cat-tag">${c.name} <i class="fas fa-times" onclick="delCat('${c.name}')"></i></span>`).join('');
            } catch(e) { log("Failed to load categories", 'error'); }
        }

        async function addCategory() {
            const name = document.getElementById('new-cat').value;
            if(!name) return;
            log(`Adding category: ${name}`);
            await fetch(`${API}/categories`, { 
                method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({name}) 
            });
            document.getElementById('new-cat').value = '';
            loadCategories();
        }

        async function delCat(name) {
            if(confirm('Delete category?')) {
                log(`Deleting category: ${name}`);
                await fetch(`${API}/categories/${name}`, { method:'DELETE' });
                loadCategories();
            }
        }
        
        // Load stats on startup if already valid (optional, usually waits for login)
        // loadStats(); 
    </script>
</body>
</html>