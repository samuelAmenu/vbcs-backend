<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VBCS Admin (Final)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #1a1f36; --accent: #009639; --bg: #f4f6f8; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 260px; background: #111; color: white; display: flex; flex-direction: column; }
        .brand { padding: 25px; font-size: 20px; font-weight: bold; border-bottom: 1px solid #333; }
        .menu { flex: 1; padding-top: 20px; }
        .nav-link { padding: 15px 25px; color: #aaa; cursor: pointer; display: flex; gap: 10px; align-items: center; text-decoration: none; }
        .nav-link:hover, .nav-link.active { background: #333; color: white; border-left: 4px solid var(--accent); }
        .main { flex: 1; display: flex; flex-direction: column; }
        .content-area { padding: 30px; overflow-y: auto; flex: 1; }
        .page { display: none; }
        .page.active { display: block; }
        
        .card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .card h3 { margin: 0 0 10px 0; font-size: 12px; color: #666; text-transform: uppercase; }
        .card .val { font-size: 28px; font-weight: bold; color: #333; }
        
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; font-size: 12px; text-transform: uppercase; color: #555; }
        
        .input-group { display: flex; gap: 10px; margin-bottom: 15px; }
        input, select, textarea { padding: 10px; border: 1px solid #ddd; border-radius: 5px; flex: 1; }
        .btn { background: var(--accent); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .btn-danger { background: #dc3545; }

        /* Status Bar */
        #status-bar { 
            position: fixed; bottom: 0; left: 260px; right: 0; 
            background: #333; color: white; padding: 10px; font-size: 12px; 
            font-family: monospace; border-top: 2px solid #009639;
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="brand">VBCS COMMAND</div>
        <div class="menu">
            <a class="nav-link active" onclick="nav('dashboard')"><i class="fas fa-chart-line"></i> Dashboard</a>
            <a class="nav-link" onclick="nav('b2c')"><i class="fas fa-users"></i> B2C Subscribers</a>
            <a class="nav-link" onclick="nav('b2b')"><i class="fas fa-building"></i> B2B Enterprises</a>
            <a class="nav-link" onclick="nav('directory')"><i class="fas fa-book"></i> Directory</a>
            <a class="nav-link" onclick="nav('settings')"><i class="fas fa-cog"></i> Settings</a>
        </div>
    </div>

    <div class="main">
        <div class="content-area">
            <div id="dashboard-page" class="page active">
                <h1>System Overview</h1>
                <div class="card-grid">
                    <div class="card"><h3>Revenue</h3><div class="val" id="d-rev">Loading...</div></div>
                    <div class="card"><h3>Subscribers</h3><div class="val" id="d-users">0</div></div>
                    <div class="card"><h3>Enterprises</h3><div class="val" id="d-ent">0</div></div>
                </div>
            </div>

            <div id="b2c-page" class="page">
                <h1>Subscribers (B2C)</h1>
                <button class="btn" onclick="loadUsers('b2c')" style="margin-bottom:10px;">Refresh List</button>
                <table id="b2c-table"><thead><tr><th>Name</th><th>Phone</th><th>Status</th><th>Joined</th></tr></thead><tbody></tbody></table>
            </div>

            <div id="b2b-page" class="page">
                <h1>Enterprises (B2B)</h1>
                <button class="btn" onclick="loadUsers('b2b')" style="margin-bottom:10px;">Refresh List</button>
                <table id="b2b-table"><thead><tr><th>Company</th><th>Phone</th><th>Role</th><th>Joined</th></tr></thead><tbody></tbody></table>
            </div>

            <div id="directory-page" class="page">
                <h1>Directory</h1>
                <div class="card">
                    <h3>Bulk Upload CSV</h3>
                    <input type="file" id="csv-file" accept="*/*">
                    <button class="btn" onclick="uploadCsv(this)" style="margin-top:10px;">Upload Database</button>
                </div>
                <table id="dir-table"><thead><tr><th>Name</th><th>Phone</th><th>Category</th></tr></thead><tbody></tbody></table>
            </div>

            <div id="settings-page" class="page">
                <h1>Settings</h1>
                <div class="card">
                    <h3>Manage Categories</h3>
                    <div class="input-group">
                        <input id="new-cat" placeholder="Category Name">
                        <button class="btn" onclick="addCategory()">Add</button>
                    </div>
                    <div id="cat-list"></div>
                </div>
            </div>
        </div>
        <div id="status-bar">System Ready.</div>
    </div>

    <script>
        // 1. USE RELATIVE PATH (Prevents CORS & URL errors)
        const API = '/api/v1/owner';
        
        function setStatus(msg) {
            document.getElementById('status-bar').innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            console.log(msg);
        }

        // 2. TIMEOUT WRAPPER (Detects "Hanging" requests)
        async function fetchWithTimeout(url, options = {}) {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), 8000); // 8 second timeout
            try {
                const response = await fetch(url, { ...options, signal: controller.signal });
                clearTimeout(id);
                return response;
            } catch (error) {
                clearTimeout(id);
                throw error;
            }
        }

        // --- NAVIGATION ---
        function nav(page) {
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            document.getElementById(`${page}-page`).classList.add('active');
            
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
            
            if(page === 'b2c') loadUsers('b2c');
            if(page === 'b2b') loadUsers('b2b');
            if(page === 'directory') loadDirectory();
        }

        // --- DATA LOADERS ---
        async function loadUsers(type) {
            setStatus(`Loading ${type} users...`);
            const tbody = document.querySelector(`#${type}-table tbody`);
            tbody.innerHTML = '<tr><td colspan="4">Loading...</td></tr>';

            try {
                const res = await fetchWithTimeout(`${API}/subscribers/${type}`);
                if (!res.ok) throw new Error(`Server Error: ${res.status}`);
                const d = await res.json();

                if (!Array.isArray(d) || d.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4">No users found.</td></tr>';
                    setStatus(`Loaded 0 users.`);
                    return;
                }

                tbody.innerHTML = d.map(u => `
                    <tr>
                        <td>${u.fullName || u.companyName || 'Unknown'}</td>
                        <td>${u.phoneNumber}</td>
                        <td>${u.role}</td>
                        <td>${new Date(u.createdAt).toLocaleDateString()}</td>
                    </tr>`).join('');
                setStatus(`Loaded ${d.length} users successfully.`);

            } catch(e) {
                handleError(e, tbody);
            }
        }

        async function loadDirectory() {
            setStatus("Loading directory...");
            const tbody = document.querySelector('#dir-table tbody');
            try {
                const res = await fetchWithTimeout(`${API}/directory`);
                const d = await res.json();
                tbody.innerHTML = d.map(i => `<tr><td>${i.companyName}</td><td>${i.phoneNumber}</td><td>${i.category}</td></tr>`).join('');
                setStatus("Directory loaded.");
            } catch(e) { setStatus("Directory load error: " + e.message); }
        }

        // --- UPLOAD FUNCTION ---
        async function uploadCsv(btn) {
            const input = document.getElementById('csv-file');
            const file = input.files[0];
            
            if(!file) return alert("Please select a file first.");
            
            setStatus(`Uploading ${file.name}...`);
            const fd = new FormData();
            fd.append('file', file);
            
            const origText = btn.innerText;
            btn.innerText = "Uploading...";
            btn.disabled = true;

            try {
                const res = await fetchWithTimeout(`${API}/directory-upload`, { method: 'POST', body: fd });
                const d = await res.json();
                
                if(res.ok) {
                    alert(d.message);
                    input.value = '';
                    loadDirectory();
                    setStatus("Upload Successful!");
                } else {
                    alert("Server Error: " + d.message);
                    setStatus("Upload Rejected by Server.");
                }
            } catch(e) {
                handleError(e);
                alert("Upload Failed. Check Status Bar.");
            }

            btn.innerText = origText;
            btn.disabled = false;
        }

        // --- SETTINGS ---
        async function addCategory() {
            const name = document.getElementById('new-cat').value;
            if(!name) return;
            setStatus("Adding category...");
            try {
                await fetchWithTimeout(`${API}/categories`, { 
                    method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({name}) 
                });
                document.getElementById('new-cat').value = '';
                setStatus("Category Added.");
            } catch(e) { handleError(e); }
        }

        // --- ERROR HANDLER ---
        function handleError(e, tbody = null) {
            let msg = e.message;
            if (e.name === 'AbortError') {
                msg = "TIMEOUT! Check MongoDB IP Whitelist (Network Access).";
            } else if (msg.includes("Failed to fetch")) {
                msg = "Connection Refused. Is server running?";
            }
            
            setStatus(`ERROR: ${msg}`);
            console.error(e);
            
            if(tbody) tbody.innerHTML = `<tr><td colspan="4" style="color:red; font-weight:bold;">${msg}</td></tr>`;
        }

        // Init
        setStatus("System Ready. Waiting for command.");
        // Try loading stats to test connection immediately
        fetchWithTimeout(`${API}/stats`)
            .then(r => r.json())
            .then(d => {
                document.getElementById('d-rev').innerText = `$${d.totalMonthlyRevenue||0}`;
                document.getElementById('d-users').innerText = d.totalB2CSubscribers||0;
                document.getElementById('d-ent').innerText = d.totalEnterprises||0;
                setStatus("Connected to Server.");
            })
            .catch(e => handleError(e));
    </script>
</body>
</html>